
<div class="container mt-5">
        {% if request.session.language == 'en' %}
        <h1>Monte Carlo Simulation for Stock Prices</h1>
        {% else %}
        <h1>Simulação de Monte Carlo para Preços de Ações</h1>
        {% endif %}
    <form id="monteCarloForm" method="post" action="{% url 'monte_carlos_simulator' %}">
        {% csrf_token %}
        <div class="form-group">
            <label for="S0">
                {% if request.session.language == 'en' %}Initial Price (S0):{% else %}Preço Inicial (S0):{% endif %}
            </label>
            <input type="number" class="form-control" id="S0" name="S0" value="100" min="1" step="0.01" required>
        </div>
        <div class="form-group">
            <label for="mu">
                {% if request.session.language == 'en' %}Annual Return (mu):{% else %}Retorno Anual (mu):{% endif %}
            </label>
            <input type="number" class="form-control" id="mu" name="mu" value="0.15" step="0.0001" max="1" required>
        </div>
        <div class="form-group">
            <label for="sigma">
                {% if request.session.language == 'en' %}Volatility (sigma):{% else %}Volatilidade (sigma):{% endif %}
            </label>
            <input type="number" class="form-control" id="sigma" name="sigma" value="0.3" step="0.0001" max="1" required>
        </div>
        <div class="form-group">
            <label for="time_unit">
                {% if request.session.language == 'en' %}Time Unit:{% else %}Unidade de Tempo:{% endif %}
            </label>
            <select class="form-control" id="time_unit" name="time_unit" required>
                {% if request.session.language == 'en' %}
                <option value="Dia">Day</option>
                <option value="Semana">Week</option>
                <option value="Mês">Month</option>
                <option value="Ano">Year</option>
                {% else %}
                <option value="Dia">Dia</option>
                <option value="Semana">Semana</option>
                <option value="Mês">Mês</option>
                <option value="Ano">Ano</option>
                {% endif %}
            </select>
        </div>
        <div class="form-group">
            <label for="num_periods">
                {% if request.session.language == 'en' %}Number of Periods:{% else %}Número de Períodos:{% endif %}
            </label>
            <input type="number" class="form-control" id="num_periods" name="num_periods" value="10" min="1" required>
        </div>
        <div class="form-group">
            <label for="num_simulations">
                {% if request.session.language == 'en' %}Number of Simulations:{% else %}Número de Simulações:{% endif %}
            </label>
            <input type="number" class="form-control" id="num_simulations" name="num_simulations" value="100" min="1" required>
        </div>
        <button type="button" class="btn btn-primary" onclick="submitMonteCarloForm()">
            {% if request.session.language == 'en' %}Run Simulation{% else %}Executar Simulação{% endif %}
        </button>
    </form>

    <!-- Result Section -->
<div class="result-section" id="resultSection" style="display: none;">
        <h3>
            {% if request.session.language == 'en' %}Simulation Results{% else %}Resultados da Simulação{% endif %}
        </h3>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <img id="pricePlot" class="img-fluid border rounded" alt="Gráfico de Preço">
            </div>
            <div class="col-md-6">
                <img id="distributionPlot" class="img-fluid border rounded" alt="Distribuição dos Preços Finais">
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12 text-center">
                <img id="convergencePlot" class="img-fluid border rounded" style="max-width: 80%;" alt="Gráfico de Convergência">
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h4>
                    {% if request.session.language == 'en' %}Descriptive Statistics{% else %}Estatísticas Descritivas{% endif %}
                </h4>
                <table class="table table-bordered table-striped" id="descStatsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>{% if request.session.language == 'en' %}Metric{% else %}Métrica{% endif %}</th>
                            <th>{% if request.session.language == 'en' %}Value{% else %}Valor{% endif %}</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="col-md-6">
                <h4>
                    {% if request.session.language == 'en' %}Inferential Statistics (Mean & CI){% else %}Estatística Inferencial (Média e IC){% endif %}
                </h4>
                <table class="table table-bordered table-striped" id="infStatsTable">
                    <thead class="table-info"> <tr>
                            <th>{% if request.session.language == 'en' %}Statistic{% else %}Estatística{% endif %}</th>
                            <th>{% if request.session.language == 'en' %}Value{% else %}Valor{% endif %}</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <small class="text-muted">
                    * {% if request.session.language == 'en' %}Based on 95% Confidence Interval (Z=1.96){% else %}Baseado no Intervalo de Confiança de 95% (Z=1,96){% endif %}
                </small>
                <div class="alert alert-light border mt-3" role="alert" style="font-size: 0.9rem; line-height: 1.4;">
                    <strong>{% if request.session.language == 'en' %}Interpretation:{% else %}Interpretação:{% endif %}</strong>
                    {% if request.session.language == 'en' %}
                        If this experiment (sample size n) were performed other times, in 95% of cases it would tend to produce an average price contained within this interval.
                    {% else %}
                        Se esse experimento (amostra de tamanho n) fosse realizado outras vezes, em 95% dos casos ele tenderia a produzir um preço médio contido nesse intervalo.
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    function submitMonteCarloForm() {
        const form = $('#monteCarloForm');
        const btn = form.find('button');
        
        btn.prop('disabled', true).text('Processando...');
        
        $.ajax({
            url: form.attr('action'),
            method: 'POST',
            data: form.serialize(),
            success: function(data) {
                $('#resultSection').fadeIn();
                
                $('#pricePlot').attr('src', 'data:image/png;base64,' + data.price_plot);
                $('#distributionPlot').attr('src', 'data:image/png;base64,' + data.distribution_plot);
                $('#convergencePlot').attr('src', 'data:image/png;base64,' + data.convergence_plot);
            
                function fillTable(tableId, dataObj) {
                    const tbody = $(tableId + ' tbody');
                    tbody.empty();
                    for (const [key, value] of Object.entries(dataObj)) {
                        let displayValue = typeof value === 'number' ? value.toFixed(4) : value;
                        if(key.includes("Limite") || key.includes("Bound")) {
                            displayValue = `<strong>${displayValue}</strong>`;
                        }
                        tbody.append(`<tr><td>${key}</td><td>${displayValue}</td></tr>`);
                    }
                }

                fillTable('#descStatsTable', data.stats_descriptive);
                fillTable('#infStatsTable', data.stats_inferential);
            },
            error: function(xhr) {
                let msg = "Erro desconhecido";
                if(xhr.responseJSON && xhr.responseJSON.error) {
                    msg = xhr.responseJSON.error;
                }
                alert("Erro: " + msg);
            },
            complete: function() {
                btn.prop('disabled', false).text('{% if request.session.language == "en" %}Run Simulation{% else %}Executar Simulação{% endif %}');
            }
        });
    }
</script>